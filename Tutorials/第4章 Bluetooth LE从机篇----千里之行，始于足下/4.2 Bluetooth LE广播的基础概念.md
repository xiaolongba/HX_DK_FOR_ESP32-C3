- [4.2.1 广播事件](#421-广播事件)
  - [4.2.1.1 传统广播事件](#4211-传统广播事件)
  - [4.2.1.2 扩展广播事件](#4212-扩展广播事件)
  - [4.2.1.3 周期广播事件](#4213-周期广播事件)
  - [4.2.1.4 广播事件类型](#4214-广播事件类型)
  - [4.2.1.5 广播间隔](#4215-广播间隔)
- [4.2.2 广播PDU与广播事件的关系](#422-广播pdu与广播事件的关系)
  - [4.2.2.1 传统广播PDU](#4221-传统广播pdu)
  - [4.2.2.2 扩展广播PDU](#4222-扩展广播pdu)
- [4.2.3 广播PHY](#423-广播phy)
- [4.2.4 广播包帧格式](#424-广播包帧格式)
  - [4.2.4.1 传统广播包](#4241-传统广播包)
  - [4.2.4.2 扩展广播包](#4242-扩展广播包)
  - [4.2.4.3 广播数据类型](#4243-广播数据类型)
- [4.2.5 结语](#425-结语)

众所周知，当我们在接触Bluetooth LE时，最先接触到的就是Bluetooth LE广播；自蓝牙规范v5.0开始，就对Bluetooth LE的广播特性做了大量地升级并新增了很多相关的特性，如扩展广播、周期广播、链式广播、广播集等；因此，本章内容将着重讲解Bluetooth LE广播的基础概念，如广播事件、广播PDUs、广播PHYs、广播间隔等等，让大家对Bluetooth LE广播有一个更加深入的了解。

# 4.2.1 广播事件
一般我们常见到的都是不同类型的广播包，但很少有人会提及什么是广播事件、广播事件与广播包又是什么关系？其实它是Bluetooth LE广播的重要组成部分；截止目前蓝牙规范v5.3，一共有如下3种广播事件：
- 传播广播事件
- 扩展广播事件
- 周期广播事件

接下来的子章节将给大家细述广播事件的具体内容。

## 4.2.1.1 传统广播事件
所谓传统广播事件（Advertising Event），指的是在广播通道 **（37，38，39）** 上发送的一个或多个广播 PDUs，而日常所说的广播包，其实就是由不同的广播事件组成；所以，它们之间的关系是如下：
![](https://docdisk.wireless-tech.cn/img/2022/09/27/adv_diagramexcalidraw_20220927235419900845.svg)

![](https://docdisk.wireless-tech.cn/img/2022/09/18/legacy_advertising_event_20220918174451381666.png)

从上图中，我们可以很清楚地看到该广播事件是由3个ADV_IND广播PDUs组成，而多个广播事件则组成了平时我们所看到的广播包，其中**两个广播事件之间的时间间隔叫广播间隔**。

## 4.2.1.2 扩展广播事件
扩展广播事件（Extended Advertising Event），指的是由在广播通道（37，38，39）上发送的一个或多个ADV_EXT_IND PDUs，以及在次级广播通道（0~36）上发送的子集PDUs组成。

![](https://docdisk.wireless-tech.cn/img/2022/09/18/extended_advertising_event_20220918223420260148.png)

跟传统广播事件不同的是，扩展广播事件除了在广播通道（37，38，39）发送PDUs，还在次级广播通道（0~36）上也发送PDUs。通过上图可知，该扩展广播事件由3个ADV_EXT_IND加上1个AUX_ADV_IND广播PDUs组成；但是，如果一个AUX_ADV_IND不足以放下剩余的广播PDUs，那么就会在AUX_ADV_IND后面接着发AUX_CHAIN_IND，直至所有的广播PDUs发送完成，才算扩展广播事件结束。

## 4.2.1.3 周期广播事件
周期广播事件（Periodic Advertising Event），指的是由在次级广播通道（0~36）上发送的AUX_SYNC_IND和其子集PDUs组成。

![](https://docdisk.wireless-tech.cn/img/2022/09/18/periodic_advertising_event_20220918225641637767.png)

由上图中，我们可以看出该周期广播事件开始于第一个AUX_SYNC_IND，而止于其子集的最后一个AUX_CHAIN_IND发送完成。

## 4.2.1.4 广播事件类型
我们或多或少都知道，有的Bluetooth LE广播是可以连接，而有的则无法与其建立连接；原因就在于Bluetooth LE广播是由多个广播事件组成的，而广播事件的类型又是多种多样的，从而组合成不同类型的Bluetooth LE广播；其中，不同类型的广播事件则由下述的不同类型组成：
- 可连接

  表示可以响应连接请求

- 不可连接

  表示不响应连接请求

- 可扫描

  表示可以响应扫描请求

- 不可扫描

  表示不响应扫描请求

- 定向

  表示只响应指定设备的请求

- 非定向

  表示可以响应任意设备的请求

而上述的这些类型，组合成不同类型的广播事件，如下：
- 可连接可扫描非定向广播事件
- 可连接不可扫描非定向广播事件
- 可连接不可扫描定向广播事件
  - 高占空比
  - 低占空比
- 不可连接不可扫描非定向广播事件
- 不可连接不可扫描定向广播事件
- 不可连接可扫描非定向广播事件
- 不可连接可扫描定向广播事件

截止蓝牙规范v5.3，上述的广播事件类型已经覆盖了所有的广播事件，包括周期广播、扩展广播和链式广播。

## 4.2.1.5 广播间隔
从上述的不同广播事件中可知，两个广播事件之间的时间间隔叫广播间隔，但蓝牙规范针对广播间隔有如下的要求：

- 非定向广播和低占空比的定向广播

  范围为**20ms ~ 10.21s**
- 周期广播

  范围为**7.5 ms ~ 81.91875 s**

- 高占空比的定向广播

  小于等于**3.75ms**且广播总时长不超过**1.28s**，仅限可连接不可扫描定向广播事件

其中，我们使用频次比较高的就是非定向广播和低占空比的定向广播，它涵盖了部分扩展广播，至于它们之间的关系由下述的章节细述。

# 4.2.2 广播PDU与广播事件的关系
由上述的[4.2.1 广播事件](#421-广播事件)和[4.2.1.4 广播事件类型](#4214-广播事件类型)可知，广播事件是由多个广播PDUs组成，但是不同类型的广播事件，其所对应的广播PDUs是不一样的。换句话说，有些广播PDUs仅适用于一部分类型的广播事件，它们之间的关系如下：

![](https://docdisk.wireless-tech.cn/img/2022/09/21/advertising_event_vs_pdu_20220921234223129889.jpg)

从上表中，可以很清楚地看到总共有如下几种广播PDUs：
1. 传播广播PDUs
   - ADV_IND
   - ADV_DIRECT_IND
   - ADV_NONCONN_IND
   - ADV_SCAN_IND

1. 扩展广播PDUs
   - ADV_EXT_IND
   - AUX_ADV_IND
   - AUX_SYNC_IND
   - AUX_CHAIN_IND

其中，同步广播PDU和链式广播PDU只能适用于不可连接不可扫描的广播事件，而且所有的扩展广播PDUs均不适用于可连接可扫描的非定向广播事件。同时，SCAN_REQ、AUX_SCAN_REQ、CONNECT_IND、AUX_CONNECT_REQ等请求PDUs，也是只适用于特定的广播事件，如由AUX_ADV_IND广播PDU组成的可连接不可扫描非定向广播事件，其仅响应AUX_CONNECT_REQ请求PDU。

## 4.2.2.1 传统广播PDU
在蓝牙规范v4.2之前（包括v4.2）的广播，我们可以称之为传统广播；而其所对应的PDU的组成结构也比较简单，如下图所示：
![](https://docdisk.wireless-tech.cn/img/2022/09/23/legacy_adv_pdu_20220923225741598564.jpg)

从上图中可以看出，除了可连接不可扫描定向广播事件不携带广播数据之外，其他的广播事件均携带广播数据；其中，每个传统广播PDU仅对应唯一的一个广播事件。

## 4.2.2.2 扩展广播PDU
扩展广播是从蓝牙规范v5.0开始才有的概念，所以蓝牙规范v5.0开始新增的广播，我们称之为扩展广播，其组成结构相比于传统广播则要复杂很多，如下图所示：
![](https://docdisk.wireless-tech.cn/img/2022/09/23/ext_adv_pdu_20220923225747263207.jpg)

上述的表格中，很清楚地展示了所有的扩展广播均起于ADV_EXT_IND，也就是说AUX_ADV_IND、AUX_SYNC_IND、AUX_CHAIN_IND都是跟在其后面的，如果有的话。那么，它们之间组成的扩展广播，就有如下几种组合：
- ADV_EXT_IND，不携带任何辅助广播PDU
  ![](https://docdisk.wireless-tech.cn/img/2022/09/27/adv_ext_indexcalidraw_20220927215114202439.svg)

  此时，ADV_EXT_IND不携带任何的辅助数据，只在37，38，39三个广播信道上发送ADV_EXT_INDs，这种类型的扩展广播很少用。

- ADV_EXT_IND--->AUX_ADV_IND，只携带一个辅助广播PDU
  ![](https://docdisk.wireless-tech.cn/img/2022/09/27/adv_ext_aux_advexcalidraw_20220927220512591777.svg)

  在37，38，39三个广播信道上发送的ADV_EXT_INDs，携带下一个在数据通道传输的辅助广播PDU信道、隔多长时间在数据通道传输辅助广播PDU等信息。

- ADV_EXT_IND--->AUX_ADV_IND--->AUX_CHAIN_IND……，携带一个辅助广播PDU + 若干个链式广播PDUs
  ![](https://docdisk.wireless-tech.cn/img/2022/09/27/adv_ext_aux_adv_aux_chainexcalidraw_20220927221208038616.svg)

  上面的图示，可以很清楚地看到当需要发送的辅助广播PDUs，一个辅助PDU不够填充的话，可以接着以AUX_CHAIN_IND继续在数据通道上传输直至所有的辅助广播PDUs发送完成。

- ADV_EXT_IND--->AUX_ADV_IND--->AUX_SYNC_IND，只携带一个辅助广播PDU + 一个周期广播PDU
  ![](https://docdisk.wireless-tech.cn/img/2022/09/27/adv_ext_aux_adv_aux_syncexcalidraw_20220927222133391703.svg)
  
  所谓周期扩展广播间隔，其实就是两个AUX_SYNC_IND之间的时间间隔，所以其可以小于正常的广播间隔，也就是图示中所述的广播间隔，但也可以大于正常的广播间隔；比如广播间隔是100ms，那么周期扩展广播也可以是20ms，但也可以是150ms，只不过此时广播间隔只有一个AUX_SYNC_IND。

- ADV_EXT_IND--->AUX_ADV_IND--->AUX_SYNC_IND--->AUX_CHAIN_IND……，只携带一个辅助广播PDU + 一个周期广播PDU + 若干个链式广播PDUs
  ![](https://docdisk.wireless-tech.cn/img/2022/09/27/adv_ext_aux_adv_aux_sync_aux_chainexcalidraw_20220927230152266027.svg)

  同理，当一个周期广播PDU不够填充的话，可以接着以AUX_CHAIN_IND继续在数据通道上传输直至所有的辅助广播PDUs发送完成。

# 4.2.3 广播PHY
通过前面的内容，我们知道蓝牙规范v5.0之后，新增了2M和CODED PHY，所以传统的广播就不适用于新的PHY，但是扩展广播则支持新的PHY，它们之间的关系如下：

![](https://docdisk.wireless-tech.cn/img/2022/09/28/pdu_vs_phy_20220928221017336562.jpg)

上表中可以看出辅助广播PDU、周期广播PDU、链式广播PDU支持所有的PHY，而其他类型的PDUs仅支持1M的PHY。

# 4.2.4 广播包帧格式
平时我们通过手机app所看到的不同广播包，它们都是解析之后呈现给用户看的，实际上它们在空中的包要比看到的复杂很多。同时，为了更好地了解广播包的具体构造，以便在后续篇章中改写广播包的内容，接下来的章节将分别对传统和扩展广播的帧格式进行剖析。

## 4.2.4.1 传统广播包
传统广播包的帧格式相对比较简单，主要的广播数据是由不同的广播数据结构组成，而广播数据结构则是由不同的长度＋对应长度的数据组成，而最后的数据则是由不同的广播数据类型＋广播数据内容组成，具体如下：

![](https://docdisk.wireless-tech.cn/img/2022/09/28/legacy_adv_data_format_20220928224933130730.jpg)

需要注意的是，传统的可连接不可扫描定向广播是不携带广播数据内容的，只有广播地址和目标地址。

## 4.2.4.2 扩展广播包
同样的，扩展广播除了新增的扩展头长度、广播模式、扩展头等字段之外，剩下的广播数据字段的组成结构与传统广播包是一样的，并没有任何的差别，但是扩展广播包中的扩展头里面，还可以携带一定数量的额外的控制层广播数据，最终的帧数据格式如下图所示：
![](https://docdisk.wireless-tech.cn/img/2022/09/28/ext_adv_data_format_20220928230743093932.jpg)

## 4.2.4.3 广播数据类型
虽说用户可以更改广播的数据内容，但这不意味着可以随便填充任意内容的广播数据，它仍然需要符合一定的规则，这也就是这一小节中所说的广播数据类型，如下图所示：
![](https://docdisk.wireless-tech.cn/img/2022/09/28/adv_data_type_20220928235324351510.jpg)

上表中清楚地表明，当前只支持上述数据类型的广播数据内容变更，如数据类型为本地名称、广播间隔等等。但凡表格中没有的数据类型，如果强行更改则会出现无法识别的问题。

# 4.2.5 结语
截止目前蓝牙规范v5.3，涉及到的相关广播内容在本文中均有覆盖，其中有广播事件及其类型、广播PDUs、广播PHYs、广播包帧格式等内容，以及它们之间的关联；而且还着重讲解了蓝牙规范v5.0新增的扩展广播相关内容，为下一篇章内容的理解打下坚实的基础。