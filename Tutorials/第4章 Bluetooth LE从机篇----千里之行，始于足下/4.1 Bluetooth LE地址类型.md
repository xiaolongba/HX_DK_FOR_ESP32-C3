- [4.1.1 Bluetooth LE地址](#411-bluetooth-le地址)
  - [4.1.2 公有地址（Public Address）](#412-公有地址public-address)
  - [4.1.3 随机地址（Random Address）](#413-随机地址random-address)
    - [4.1.3.1 静态地址（Static Address）](#4131-静态地址static-address)
    - [4.1.3.2 私有地址（Private Address）](#4132-私有地址private-address)
      - [4.1.3.2.1 可解析私有地址（Resolvable Private Address）](#41321-可解析私有地址resolvable-private-address)
      - [4.1.3.2.2 不可解析私有地址（Non-Resolvable Private Address)](#41322-不可解析私有地址non-resolvable-private-address)
- [4.1.2 不同地址间的区别](#412-不同地址间的区别)
  - [4.1.2.1 公共地址（Public Address）](#4121-公共地址public-address)
  - [4.1.2.2 静态地址（Static Address）](#4122-静态地址static-address)
  - [4.1.2.3 可解析私有地址（Resolvable Private Address）](#4123-可解析私有地址resolvable-private-address)
  - [4.1.2.4 不可解析私有地址（Non-Resolvable Private Address)](#4124-不可解析私有地址non-resolvable-private-address)
- [4.1.3 结语](#413-结语)


在Bluetooth LE领域中，地址是每个Bluetooth LE设备不可或缺的重要组成部分，通过这个地址就可以找到并识别出这个Bluetooth LE设备，不然根本无法分清如果周边存在多个Bluetooth LE设备的话；那么，本章内容将细述Bluetooth LE地址类型及其作用。

# 4.1.1 Bluetooth LE地址
众所周知，Bluetooth LE地址分成**公有地址**和**随机地址**，而随机地址又分**静态地址**和**私有地址**，同时私有地址又再分为**可解析私有地址**和**不可解析私有地址**，它们之间的关系如下图所示：

![](https://docdisk.wireless-tech.cn/img/2022/09/13/Bluetooth%20LE%E5%9C%B0%E5%9D%80_20220913225937461184.svg)

## 4.1.2 公有地址（Public Address）
Bluetooth LE的公有地址，就类似于我们日常生活中的身份证号码，是全球唯一的且不可改变的，其具备如下几个特性：
1. 为了保证Bluetooth LE地址的全球唯一性，其需要向[IEEE](https://standards.ieee.org/products-services/regauth/index.html)购买，然后IEEE组织就会对应地分配公有地址给买家；
2. 如果想要查询某Bluetooth LE设备的公有地址是哪家公司的，则可以点此[链接](https://regauth.standards.ieee.org/standards-ra-web/pub/view.html#registries)查询，如ESP32-C3的每个芯片都自带有一个公有地址：
    <img src=https://docdisk.wireless-tech.cn/img/2021/10/19/public_address_espressif_20211019225239877291.png width = "" height = "" alt="" align=center />

    <img src=https://docdisk.wireless-tech.cn/img/2021/10/19/public_address_espressif_ieee_20211019225257760619.png width = "" height = "" alt="" align=center />

3. 全球唯一且存在于Bluetooth LE设备的整个生命周期，都不会改变；
4. 总长度为6个字节，其组成结构如下图所示：
    
    <img src=https://docdisk.wireless-tech.cn/img/2021/10/19/Public-Address-Format_20211019225316261985.png width = "" height = "" alt="" align=center />

    - Company ID：IEEE分配的（最高有效位）
    - Company Assigned：公司内部分配的（最低有效位）
  
    
    从上述的ESP32-C3的公有地址可以看出，高24bits由于具备全球唯一性，所以可以被捉包器识别出来是哪一家公司，而低24bits则是乐鑫公司自己分配的；
## 4.1.3 随机地址（Random Address）
除了公有地址类型之外，还有一个随机地址类型，其又分为**静态地址（Static Address）** 和 **私有地址（Private Address）**，它们之间主要通过最高的2位有效位来区分，具体如下所示：
### 4.1.3.1 静态地址（Static Address）
同样，其总长度也是48bits，但是最高的2位有效位是`0b11`，组成结构如下图所示：
  
<img src=https://docdisk.wireless-tech.cn/img/2021/10/19/static-address-formatdrawio_20211019225339424241.png width = "" height = "" alt="" align=center />

该地址类型的主要特点如下：
1. 静态地址的随机部分至少有一个bit是0和1；
1. 用户在满足上述条件的情况下，可以自行配置Bluetooth LE设备的静态地址；
1. 静态地址在上电之后，不可中途改变；
1. 只能在重新上电之后，才能改变静态地址的内容 **（非强制性，也可以不改变）**；
1. 如果Bluetooth LE设备的静态地址改变了，那么如果对端设备存放了之前的静态地址，这就会导致重连旧的地址时失败；

### 4.1.3.2 私有地址（Private Address）
BLE的私有地址又分为**不可解析私有地址（Non-Resolvable Private Address)** 和 **可解析私有地址（Resolvable Private Address）**，它们之间的主要区别如下：

#### 4.1.3.2.1 可解析私有地址（Resolvable Private Address）
该类型的地址的长度大小同样为48bits，最高的2位有效位是`0b10`，其组成结构如下图所示：

<img src=https://docdisk.wireless-tech.cn/img/2021/10/19/resolvable-private-addressdrawio_20211019225415274851.png width = "" height = "" alt="" align=center />

该类型的地址所对应的特点如下：
1. 上图中显示的随机部分 **（prand）** 的内容至少有一个bit是0和1；
1. 该地址会周期性变化，蓝牙规范推荐15分钟更新一次，但不要超过1小时

其中，`hash = ah(IRK, prand)`，prand则是设备本地随机产生的24bits数据，而IRK值可以是在设备本地随机产生或者在设备生产时分配。
#### 4.1.3.2.2 不可解析私有地址（Non-Resolvable Private Address)
顾名思义，就是说该私有地址不可以被解析，其组成结构如下图所示：

<img src=https://docdisk.wireless-tech.cn/img/2021/10/19/non-resolvable-private-address-formatdrawio_20211019225452704912.png width = "" height = "" alt="" align=center />

同样，其总长度为48bits，但是最高的2位有效位是`0b00`，其对应的特点如下：
1. 随机部分的内容至少有一个bit是0和1；
1. 不可解析私有地址不能与公有地址相同；
1. 该地址会周期性变化；蓝牙规范推荐15分钟更新一次，但不要超过1小时

# 4.1.2 不同地址间的区别
介绍完上述不同类型的地址之后，我相信读者更多地想知道如何使用这些类型的地址，或者说在什么场景下使用这些类型的地址。
## 4.1.2.1 公共地址（Public Address）
该类型的地址是全球唯一且固定的，理论上重复的概率基本为0，因为它们是由[IEEE组织](https://standards.ieee.org/products-services/regauth/index.html)分配给买家的，适用于为保证BLE设备地址的唯一性，方便其他人辩别，但缺点是这些地址是需要付费的。

## 4.1.2.2 静态地址（Static Address）
该类型的地址，是为了方便各Bluetooth LE设备生产商自行生成自己的Bluetooth LE地址；因为这种类型的地址是免费的，不需要向IEEE组织购买，同时在一定范围内还能保证地址的唯一性。

## 4.1.2.3 可解析私有地址（Resolvable Private Address）
可解析私有地址的目的是防止恶意第三方跟踪蓝牙设备，同时仍允许一个或多个受信任方识别感兴趣的BLE设备。而可解析的意思就是说：
> Bluetooth LE设备自身产生的IRK与受信任方分享之后，当受信任方的Bluetooth LE设备接收到可解析私有地址，就会提取出`prand`值再与对端设备分享的`IRK`，进行**ah**计算得出一个`localHash`值，与可解析私有地址中的`hash`值进行比对，如果匹配上了那么对等设备的身份就已经解析。

换句话说，可解析私有地址仍然可以被扫描获取得到，只不过它会周期变化，让第三方难于追踪。

## 4.1.2.4 不可解析私有地址（Non-Resolvable Private Address)
相较于可解析私有地址，该类型的地址是不可解析的，所以这种类型的地址不太常用，但是有时会在一些Beacon的应用上使用；此类地址的唯一目的是防止任何其他Bluetooth LE设备进行跟踪。

# 4.1.3 结语
Bluetooth LE设备的地址必须是公有地址或者静态地址，而不可解析和可解析地址是可选的。换句话说，即使使用了不可解析或者可解析地址，Bluetooth LE设备还必须仍然存在公有地址或者静态地址，也就是此时Bluetooth LE设备有两种类型的地址，因为不可解析和可解析地址仅用于解决隐私问题。

同时，我们无法直接从地址上判断，当前这个地址是上述的哪一种类型的地址，还需要结合**公有地址**和**随机地址**类型来组合判断。