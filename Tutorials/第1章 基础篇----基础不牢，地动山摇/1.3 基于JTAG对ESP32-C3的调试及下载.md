- [1.3.1 JTAG接口](#131-jtag接口)
  - [1.3.1.1 内置的USB-SERIAL-JTAG](#1311-内置的usb-serial-jtag)
  - [1.3.1.2 实验一](#1312-实验一)
    - [1.3.1.2.1 下载](#13121-下载)
      - [1.3.1.2.1.1 UART下载](#131211-uart下载)
      - [1.3.1.2.1.2 JTAG下载](#131212-jtag下载)
    - [1.3.1.2.2 调试仿真](#13122-调试仿真)
  - [1.3.1.3 外置的ESP-Prog](#1313-外置的esp-prog)
  - [1.3.1.4 实验二](#1314-实验二)
    - [1.3.1.4.1 下载](#13141-下载)
      - [1.3.1.4.1.1 UART下载](#131411-uart下载)
      - [1.3.1.4.1.2 JTAG下载](#131412-jtag下载)
    - [1.3.1.4.2 调试仿真](#13142-调试仿真)

继上一章节[《1.2 基于VSCode的ESP32-C3开发环境的搭建》](1.2%20基于VSCode的ESP32-C3开发环境的搭建.md)之后，小编相信大部分读者，应该可以轻松地搞定ESP32-C3的开发环境搭建，并完成一些基础的开发；接下来，让我们继续趁热打铁，继续讲讲如何利用JTAG接口对ESP32-C3进行下载和调试仿真。

# 1.3.1 JTAG接口
为了更好地阐述并实现对ESP32-C3进行下载以及调试仿真，这里小编以[HX-DK-商](https://item.taobao.com/item.htm?spm=a1z10.1-c-s.w4004-22286946226.12.59ca2c2c5a3wJ3&id=654877303965)为蓝本，进行一系列的配置和讲解。

![](https://docdisk.wireless-tech.cn/img/2022/09/12/hx_dk_shang_20220912170741038318.png)

目前，ESP32-C3支持两种JTAG连接方式：
1. 内嵌的JTAG调试仿真器

    ESP32-C3内嵌了一个USB-JTAG控制器，可用于对ESP32-C3进行下载或者调试仿真，如[HX-DK-商](https://item.taobao.com/item.htm?spm=a1z10.1-c-s.w4004-22286946226.12.59ca2c2c5a3wJ3&id=654877303965)中的标号9，只要插上Type-C线，即可实现下载和调试仿真的功能。
2. 外置的JTAG调试仿真器

    如果想要使用外部的调试仿真器，则只要使用`标准的10-PIN连接线`与[HX-DK-商](https://item.taobao.com/item.htm?spm=a1z10.1-c-s.w4004-22286946226.12.59ca2c2c5a3wJ3&id=654877303965)中的标号8相连接，即可实现对ESP32-C3的下载和调试仿真。

## 1.3.1.1 内置的USB-SERIAL-JTAG
ESP32-C3不但内置了`USB-JTAG`，还内置了`USB-SERIAL`，这给开发者提供了大大的便利，仅需要一根Type-C线即可实现下载和调试仿真，然而它始终属于ESP32-C3中的一个外设，一旦设备进入休眠又或者死机了又或者重启了，那么这个外设的功能也随之 **"失效"** 了，假设如果没有这些问题的话，那还是很不错的，这也是目前内置USB-SERIAL-JTAG的局限性所在。所以，[HX-DK-商](https://item.taobao.com/item.htm?spm=a1z10.1-c-s.w4004-22286946226.12.59ca2c2c5a3wJ3&id=654877303965)仍然保留了外置的USB-SERIAL和调试仿真器。

在使用内置的USB-SERIAL-JTAG功能之前，用户还需要安装相应的驱动，即在任意地方以管理员权限打开Powershell，然后键入以下命令：
```
Invoke-WebRequest 'https://dl.espressif.com/dl/idf-env/idf-env.exe' -OutFile .\idf-env.exe; .\idf-env.exe driver install --espressif
```

如果驱动安装成功，当[HX-DK-商](https://item.taobao.com/item.htm?spm=a1z10.1-c-s.w4004-22286946226.12.59ca2c2c5a3wJ3&id=654877303965)中的标号9只要插上Type-C线，在设备管理器中就可以发现一个`虚拟的串口`和一个`USB-JTAG的接口`，如下所示：

![](https://docdisk.wireless-tech.cn/img/2022/09/12/idf_driver_device_manager_20220912183057016097.png)

此时，用户就可以利用内置的USB-SERIAL-JTAG对ESP32-C3进行下载和调试。

## 1.3.1.2 实验一
### 1.3.1.2.1 下载
ESP32-C3的固件下载有两种方式：
#### 1.3.1.2.1.1 UART下载

  因为内置有USB-SERIAL，且驱动也已经安装成功，那么用户只需要在VSCode上进行简单地配置，即可下载：
  
  - 在VSCode状态栏左下方，选择内置USB-SERIAL的虚拟串口

      ![](https://docdisk.wireless-tech.cn/img/2022/09/12/idf_extension_uart_com_20220912183724002009.png)

  - 在ESP-IDF插件设置中，选择串口方式下载固件

      ![](https://docdisk.wireless-tech.cn/img/2022/09/11/idf_flash_type_20220911234405324423.png)
      
  - 在VSCode状态栏左下方，选择芯片的型号

      ![](https://docdisk.wireless-tech.cn/img/2021/10/18/idf_extension_device_type_20211018235105590774.png)

当上述的配置设置完成之后，即实现内置的USB-SERIAL对ESP32-C3进行下载，如下所示：
![](https://docdisk.wireless-tech.cn/img/2021/10/18/UART_Buit-in_download_20211018235143197628.gif)

#### 1.3.1.2.1.2 JTAG下载

  同理，用户只需要在VSCode上进行简单地配置即可：

  - 在ESP-IDF插件设置中，选择JTAG方式下载固件

      ![](https://docdisk.wireless-tech.cn/img/2021/10/18/idf_extension_jtag_20211018235313621755.png)
      
  - 在VSCode状态栏左下方，选择芯片的型号

      ![](https://docdisk.wireless-tech.cn/img/2021/10/18/idf_extension_device_type_20211018235425731503.png)

当上述的配置设置完成之后，即实现内置的USB-JTAG对ESP32-C3进行下载，如下所示：
![](https://docdisk.wireless-tech.cn/img/2021/10/18/JTAG_Buit-in_download_20211018235335442241.gif)

### 1.3.1.2.2 调试仿真
想要使用内置的USB-JTAG对ESP32-C3进行调试仿真，需要如下2个步骤：

1. 同样的，在VSCode状态栏左下方，选择芯片的型号，即：
![](https://docdisk.wireless-tech.cn/img/2021/10/18/idf_extension_device_type_20211018235425731503.png)

1. 配置当前代码工程的`launch.json`文件为下述的内容：
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "espidf",
      "name": "Launch-name",
      "request": "launch",
      "mode": "auto",
      "skipVerifyAppBinBeforeDebug": true
    }
  ]
}
```

当上述的配置设置完成之后，为了保证调试仿真的鲁棒性，请先用上述的`JTAG下载`的方法先下载固件 **（如果固件没有更新，一次即可；如果有更新，则务必再下载一次）**，然后再按下`F5`键，即可实现内置的USB-JTAG对ESP32-C3进行调试仿真，如下图所示：
![](https://docdisk.wireless-tech.cn/img/2021/10/18/JTAG_Buit-in_debug_20211018235715623520.gif)

> 如果突然间出现无法调试仿真的情况，先用上述的`JTAG下载`的方法先下载固件，紧接着硬件复位一下ESP32-C3，然后再按下`F5`键进行调试仿真。

**注意：按照上述的步骤之后，但是仍然出现`ModuleNotFoundError: No module named 'win32api'`** ，此时就应该调用下述的命令查看是否有安装pywin32，命令如下所示：
```c
f:\Tools\Espressif\IDF_Tools\.espressif\python_env\idf5.1_py3.9_env\Scripts\python.exe -m pip list -l
Package               Version
--------------------- ---------
bitstring             3.1.9
Brotli                1.0.9
certifi               2021.10.8
cffi                  1.15.0
charset-normalizer    2.0.7
click                 8.0.3
colorama              0.4.4
construct             2.10.67
contextlib2           21.6.0
cryptography          36.0.1
ecdsa                 0.17.0
esp-windows-curses    0.1
Flask                 0.12.5
Flask-Compress        1.10.1
Flask-SocketIO        2.9.6
future                0.18.2
gdbgui                0.13.2.0
gevent                1.5.0
greenlet              1.1.2
idf-component-manager 1.0.1
idna                  3.3
itsdangerous          2.0.1
Jinja2                3.0.2
kconfiglib            14.1.0
MarkupSafe            2.0.1
pip                   22.0.4
pycparser             2.20
pyelftools            0.27
pygdbmi               0.9.0.2
Pygments              2.10.0
pyparsing             3.0.7
pyserial              3.5
python-engineio       3.14.2
python-socketio       4.6.1
pywin32               303
PyYAML                6.0
reedsolo              1.5.4
requests              2.26.0
requests-toolbelt     0.9.1
schema                0.7.4
semantic-version      2.8.5
setuptools            60.5.0
six                   1.16.0
tqdm                  4.62.3
urllib3               1.26.7
Werkzeug              0.16.1
wheel                 0.37.0
windows-curses        2.3.0
```
如果键入上述的命令之后，没有发现`pywin32`，则要安装它，命令如下：
```c
f:\Tools\Espressif\IDF_Tools\.espressif\python_env\idf5.1_py3.9_env\Scripts\python.exe -m pip install pywin32
```

## 1.3.1.3 外置的ESP-Prog
如上述的**内置的USB-SERIAL-JTAG**内容所述，内置的USB-SERIAL-JTAG控制器仍然存在一些瑕疵，所以有的应用场景仍然需要外部的调试仿真器来下载以及调试仿真。


同理，外置的ESP-Prog在使用之前，也是需要安装驱动文件的，其方法也跟内置的USB-SERIAL-JTAG的相似，即在任意地方以管理员权限打开Powershell，然后键入以下命令：
```
Invoke-WebRequest 'https://dl.espressif.com/dl/idf-env/idf-env.exe' -OutFile .\idf-env.exe; .\idf-env.exe driver install --ftdi
```

如果驱动安装成功，ESP-Prog只要插上USB线，在设备管理器中就可以发现一个`虚拟的串口`和一个`USB-JTAG的接口`，如下所示：

![](https://docdisk.wireless-tech.cn/img/2021/10/18/idf_driver_esp_prog_device_manager_20211018235835916594.png)

这个时候，用户就可以利用外置的ESP-Prog对ESP32-C3进行下载和调试。还有一点需要注意的是：当ESP Prog与[HX-DK-商](https://item.taobao.com/item.htm?spm=a1z10.1-c-s.w4004-22286946226.12.59ca2c2c5a3wJ3&id=654877303965)的标号8相连接时，请**将ESP Prog的`JTAG_PWR_SEL`拨到5V，然后`HX－DK－商开发板`什么线都不需要接**。

## 1.3.1.4 实验二
### 1.3.1.4.1 下载
由于ESP Prog调试仿真器也具备USB-JTAG和USB-SERIAL的功能，所以其也支持两种方式的下载：

#### 1.3.1.4.1.1 UART下载

  这种方式比较简单，只需要将对应的TX和RX相互连接即可；至于ESP Prog的TX、RX引脚详情，请参考[ESP Prog官方的介绍](https://docs.espressif.com/projects/espressif-esp-iot-solution/en/latest/hw-reference/ESP-Prog_guide.html?highlight=esp%20prog)，因为这种方式大同小异，小编就不再细述。

  <img src="https://docdisk.wireless-tech.cn/img/2022/04/09/2022-04-09_125751_963972.png" width = "300" height = "" alt="" align=center />

#### 1.3.1.4.1.2 JTAG下载

  如果使用外置ESP-Prog的JTAG接口对ESP32-C3进行下载，用户还需要对ESP32-C3内部的eFuse进行设置 **（注意，该设置是永久的，不可恢复的）**，即需要使用`espefuse.py`对eFuse的`JTAG_SEL_ENABLE`位进行烧录，操作的命令如下：
  ```c
  F:/Tools/Espressif/IDF_Tools/.espressif/python_env/idf5.1_py3.9_env/Scripts/python.exe F:\BLE_WIFI\Espressif\SDK\esp-idf-c3\components\esptool_py\esptool\espefuse.py -p COM50 burn_efuse JTAG_SEL_ENABLE 1
  ```
  上述是小编当前的`Python`版本和`espefuse.py`路径和`COM口`，不同的用户可能对应的路径些许不同。当按照上述的命令配置之后，ESP32-C3在复位时，会根据**GPIO10**的电平来判断使用内置USB-JTAG还是外置的JTAG调试仿真器：
  - GPIO10为低电平时，使用内置的USB-JTAG
  - GPIO10为高电平时，使用外置的JTAG调试仿真器

  **但是！！！目前这个功能截止目前为止还有Bug，只能通过下一版的硬件升级才能解决这个问题；当前的现状就是只要烧录了JTAG_SEL_ENABLE位，ESP32-C3就永远只能支持外置的JTAG调试仿真器了**

  紧接着，我们就可以进行JTAG烧录了，即：
  1. 在ESP-IDF插件设置中，选择JTAG方式下载固件

      ![](https://docdisk.wireless-tech.cn/img/2021/10/19/idf_extension_jtag_20211019000552993886.png)
      
  1. 在VSCode状态栏左下方，选择芯片的型号

      ![](https://docdisk.wireless-tech.cn/img/2021/10/19/idf_extension_device_type_esp_prog_20211019000609235839.png)

当上述的配置设置完成之后，即实现外置的ESP Prog对ESP32-C3进行下载，如下所示：
![](https://docdisk.wireless-tech.cn/img/2021/10/19/ESP_Prog_Buit-in_download_20211019000652676315.gif)

### 1.3.1.4.2 调试仿真
同理，使用外置ESP Prog调试仿真器的设置，与使用内置的USB－SERIAL－JTAG是一样的；唯一不同的是：**只不过当选择设备类型时，要选择`ESP32-C3(ESP-PROG JTAG)`** ；小编这里也不再过多地描述，下图是使用外置ESP Prog调试仿真器的动图：
![](https://docdisk.wireless-tech.cn/img/2021/10/19/ESP_Prog_Buit-in_debug_20211019000759386022.gif)

至此，如何基于JTAG接口对ESP32-C3进行下载及调试仿真已经讲解完成了。